name: SDK Integrated CI (Lint, Matrix Test, Coverage & Dashboard)

on:
  push:
    branches: [ "**" ]
  pull_request:
    branches: [ "main" ]

permissions:
  contents: write
  pull-requests: write
  checks: write
  pages: write
  id-token: write

jobs:
  # -----------------------------------------------------------------
  # JOB 1: Code style check, Formatting
  # -----------------------------------------------------------------
  lint-and-format:
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}
      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install Linting Tools
        run: pip install black isort flake8
      - name: Run Isort & Black (Auto-fix)
        run: |
          isort .
          black .
      - name: Commit & Push changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "style: Apply automatic code formatting"
          branch: ${{ github.head_ref }}
      - name: Run Flake8
        run: flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics

  # -----------------------------------------------------------------
  # JOB 2: OS, Python version matrix test
  # -----------------------------------------------------------------
  test-matrix:
    needs: lint-and-format
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-24.04]
        python-version: ["3.8", "3.9", "3.10", "3.11", "3.12"]
    env:
      TL_API_KEY: ${{ secrets.TL_API_KEY }}
      TL_INDEX_ID: ${{ secrets.TL_INDEX_ID }}
      TL_INDEX_MARENGO_27: ${{ secrets.TL_INDEX_MARENGO_27 }}
      TL_INDEX_MARENGO_30: ${{ secrets.TL_INDEX_MARENGO_30 }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'

      - name: Clone SDK repository
        shell: bash
        run: |
          git clone https://github.com/twelvelabs-io/twelvelabs-python.git sdk-source
          cd sdk-source

      - name: Install SDK in editable mode
        shell: bash
        run: |
          cd sdk-source
          python -m pip install --upgrade pip
          pip install -e .

      - name: Install Dependencies (Add pytest-html)
        shell: bash
        run: |
          python -m pip install --upgrade pip
          # Install pytest-html plugin
          pip install pytest pytest-mock pytest-html
          if [ -f requirements.txt ]; then 
            grep -v "^twelvelabs" requirements.txt | grep -v "^$" | pip install -r /dev/stdin || true
          fi

      - name: Run Tests (Generate XML & HTML)
        shell: bash
        run: |
          # Create folder to collect results
          mkdir -p test-results
          # Generate HTML report with --html option
          # --self-contained-html: Include CSS etc. in HTML to make a single file
          pytest --junitxml=test-results/junit.xml --html=test-results/report.html --self-contained-html

      # [Important] Upload entire folder (XML for statistics, HTML for viewing)
      - name: Upload Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: result-${{ matrix.python-version }}
          path: test-results/

  # -----------------------------------------------------------------
  # JOB 3: Coverage measurement
  # -----------------------------------------------------------------
  coverage-report:
    needs: lint-and-format
    runs-on: ubuntu-24.04
    env:
      TL_API_KEY: ${{ secrets.TL_API_KEY }}
      TL_INDEX_ID: ${{ secrets.TL_INDEX_ID }}
      TL_INDEX_MARENGO_27: ${{ secrets.TL_INDEX_MARENGO_27 }}
      TL_INDEX_MARENGO_30: ${{ secrets.TL_INDEX_MARENGO_30 }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Clone SDK repository
        run: |
          git clone https://github.com/twelvelabs-io/twelvelabs-python.git sdk-source
          cd sdk-source
          pip install -e .
      - name: Install Dependencies
        run: |
          pip install --upgrade pip
          pip install pytest pytest-cov pytest-mock
          if [ -f requirements.txt ]; then 
            grep -v "^twelvelabs" requirements.txt | grep -v "^$" | pip install -r /dev/stdin || true
          fi
      - name: Run Tests with Coverage
        run: |
          pytest --cov=twelvelabs --cov-report=term --cov-report=html:htmlcov --cov-report=xml:coverage.xml --junitxml=pytest.xml
      - name: Publish Coverage Comment
        if: github.event_name == 'pull_request'
        uses: MishaKav/pytest-coverage-comment@main
        with:
          pytest-coverage-path: ./coverage.xml
          junitxml-path: ./pytest.xml
          title: üîç Test Coverage Report
          badge-title: Coverage
          hide-badge: false
          create-new-comment: false
          report-only-changed-files: true
      - name: Upload Coverage HTML Report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-html-report
          path: htmlcov/

  # -----------------------------------------------------------------
  # JOB 4: Dashboard generation
  # -----------------------------------------------------------------
  deploy-dashboard:
    needs: [test-matrix, coverage-report]
    runs-on: ubuntu-24.04
    permissions:
      pages: write
      id-token: write
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # 1. Download all test results (path: public/reports/result-3.x/)
      - name: Download Matrix Test Results
        uses: actions/download-artifact@v4
        with:
          pattern: result-*
          path: public/reports

      # 2. Download coverage (path: public/coverage/)
      - name: Download Coverage HTML
        uses: actions/download-artifact@v4
        with:
          name: coverage-html-report
          path: public/coverage

      # 3. Landing Page generation script
      - name: Generate Dashboard Landing Page
        run: |
          python -c "
          import os
          import glob
          import xml.etree.ElementTree as ET

          # Write HTML header
          html_content = '''
          <!DOCTYPE html>
          <html lang=\"en\">
          <head>
            <meta charset=\"UTF-8\">
            <title>SDK CI Dashboard</title>
            <style>
              body { font-family: -apple-system, sans-serif; padding: 40px; background: #f6f8fa; color: #24292e; }
              .container { max-width: 900px; margin: 0 auto; }
              h1 { border-bottom: 1px solid #eaecef; padding-bottom: 10px; }
              .card { background: white; padding: 20px; margin-bottom: 20px; border: 1px solid #e1e4e8; border-radius: 6px; }
              table { width: 100%; border-collapse: collapse; margin-top: 10px; }
              th, td { padding: 12px; text-align: left; border-bottom: 1px solid #eaecef; }
              th { background-color: #f6f8fa; }
              .pass { color: #2ea44f; font-weight: bold; }
              .fail { color: #cb2431; font-weight: bold; }
              .skip { color: #f66a0a; font-weight: bold; }
              .btn { display: inline-block; padding: 6px 12px; background: #0366d6; color: white; text-decoration: none; border-radius: 6px; font-size: 14px; }
              .btn:hover { background: #0255b3; }
            </style>
          </head>
          <body>
            <div class=\"container\">
              <h1>üõ°Ô∏è CI Dashboard</h1>
              
              <div class=\"card\">
                <h2>üìä Coverage Report</h2>
                <p>Latest code coverage metrics.</p>
                <a href=\"coverage/index.html\" class=\"btn\">View Coverage Details</a>
              </div>

              <div class=\"card\">
                <h2>üß™ Matrix Test Summary</h2>
                <table>
                  <thead>
                    <tr>
                      <th>Python Version</th>
                      <th>Total</th>
                      <th>Pass</th>
                      <th>Fail</th>
                      <th>Error</th>
                      <th>Skip</th>
                      <th>Report</th>
                    </tr>
                  </thead>
                  <tbody>
          '''

          # Iterate through result folders for each version (public/reports/result-*)
          # Sort glob results to order by version
          report_dirs = sorted(glob.glob('public/reports/result-*'))

          for report_dir in report_dirs:
              # Extract version from folder name (result-3.8 -> 3.8)
              version = os.path.basename(report_dir).replace('result-', '')
              
              xml_path = os.path.join(report_dir, 'junit.xml')
              html_link = f'reports/result-{version}/report.html'
              
              total = 0
              failures = 0
              errors = 0
              skipped = 0
              passed = 0
              
              try:
                  # Parse XML to extract statistics
                  tree = ET.parse(xml_path)
                  root = tree.getroot()
                  # Handle both testsuites and testsuite cases
                  if root.tag == 'testsuites':
                      for suite in root:
                          total += int(suite.get('tests', 0))
                          failures += int(suite.get('failures', 0))
                          errors += int(suite.get('errors', 0))
                          skipped += int(suite.get('skipped', 0))
                  else:
                      total = int(root.get('tests', 0))
                      failures = int(root.get('failures', 0))
                      errors = int(root.get('errors', 0))
                      skipped = int(root.get('skipped', 0))
                  
                  passed = total - failures - errors - skipped
                  
                  status_class = 'fail' if (failures + errors) > 0 else 'pass'
                  
                  html_content += f'''
                    <tr>
                      <td><strong>Python {version}</strong></td>
                      <td>{total}</td>
                      <td class=\"pass\">{passed}</td>
                      <td class=\"fail\">{failures}</td>
                      <td class=\"fail\">{errors}</td>
                      <td class=\"skip\">{skipped}</td>
                      <td><a href=\"{html_link}\" class=\"btn\">View Log</a></td>
                    </tr>
                  '''
              except Exception as e:
                  print(f'Error parsing {xml_path}: {e}')
                  html_content += f'''
                    <tr>
                      <td>Python {version}</td>
                      <td colspan=\"6\" class=\"fail\">Error parsing results</td>
                    </tr>
                  '''

          html_content += '''
                  </tbody>
                </table>
              </div>
              <div style=\"text-align: center; color: #666; margin-top: 20px;\">
                Generated via GitHub Actions
              </div>
            </div>
          </body>
          </html>
          '''

          # Save index.html
          with open('public/index.html', 'w') as f:
              f.write(html_content)
          
          print('Dashboard generated successfully at public/index.html')
          "

      # 4. Upload GitHub Pages artifact
      - name: Upload Pages Artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: public/

      # 5. Deploy
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4